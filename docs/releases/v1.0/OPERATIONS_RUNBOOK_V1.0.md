# Operations Runbook - V1.0

## 1. 目的

为 `V1.0` 提供标准化运行与故障处置流程，确保问题可快速定位、可快速恢复。

## 2. 值班与响应

- 值班角色：当班工程师（Owner）
- 响应等级：
  - `P0`：主链路不可用，立即处理
  - `P1`：核心功能受影响，30 分钟内介入
  - `P2`：一般问题，按计划修复

## 3. 关键服务清单

- `frontend`（Next.js）
- `backend`（FastAPI）
- `postgres`
- `redis`
- `nginx`（如启用）

## 4. 故障处理总流程

1. 确认告警或异常现象
2. 判断影响范围（用户/接口/环境）
3. 执行最小化诊断（健康检查、日志、最近发布）
4. 采取处置（修复/降级/回滚）
5. 验证恢复结果
6. 记录事件与后续行动项

## 5. 快速诊断清单（优先顺序）

1. `GET /healthz` 是否 200
2. `POST /api/v1/chat/completions` 是否可用
3. 错误码是否集中为 `TIMEOUT` 或 `INTERNAL_ERROR`
4. 最近 30 分钟是否有发布
5. 数据库连接是否可用
6. 日志是否包含连续异常堆栈

## 6. 常见场景处置

## 6.1 主链路不可用

- 现象：`chat/completions` 大面积失败
- 处置：
  - 检查 `backend` 存活与端口监听
  - 检查数据库连通性
  - 立即评估回滚（见 `docs/releases/v1.0/ROLLBACK_PLAN_V1.0.md`）

## 6.2 响应显著变慢

- 现象：请求超时升高
- 处置：
  - 检查上游模型调用耗时
  - 检查连接池与资源占用
  - 临时降低并发或启用降级回复

## 6.3 错误码异常飙升

- 现象：`INVALID_ARGUMENT` 或 `INTERNAL_ERROR` 激增
- 处置：
  - 核查近期 API 契约变更
  - 对照 `docs/releases/v1.0/API_CONTRACT_V1.md` 校验请求格式
  - 必要时回退到稳定版本

## 7. 变更操作基线

- 发布前必须完成 `docs/releases/v1.0/RELEASE_CHECKLIST_V1.0.md`
- 发布后需观察 30-60 分钟关键指标
- 出现 P0/P1 必须同步事件记录

## 8. 事件复盘模板

- 事件编号：
- 开始时间：
- 恢复时间：
- 影响范围：
- 根因：
- 处置动作：
- 永久修复项：
- 截止日期与责任人：


