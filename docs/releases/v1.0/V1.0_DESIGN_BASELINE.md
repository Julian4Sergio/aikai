# V1.0 设计基线（Scope Freeze）

## 1. 文档目的

冻结 `V1.0` 的设计边界，作为实现、评审、测试与验收的统一输入。  
如与现有规范冲突，以更新规范文档并说明原因为先（参考 `docs/foundation/DEV_WORKFLOW.md`）。

## 2. 版本目标

在最小可用范围内交付单轮问答能力，确保端到端可用、可观测、可演进。

## 3. 范围（In Scope）

- 单轮提问与回答（无多轮上下文）
- 单用户 `personal` 模式
- 极简前端聊天页面（输入问题、展示回答、基础错误提示）
- 极简后端问答接口
- 健康检查接口
- 基础结构化日志与错误处理

## 4. 非范围（Out of Scope）

- 多轮会话/上下文窗口
- 记忆管理（短期/长期）
- 知识库接入与检索（RAG）
- MCP 工具调用
- 完整组织/租户管理能力

## 5. 架构与约束（必须满足）

- 架构风格：模块化单体，按领域边界组织
- 仅启用 `chat` 模块；`memory`、`knowledge`、`tooling` 作为扩展点预留
- 核心数据模型预留 `tenant_id`
- 系统配置预留 `edition`（`personal | enterprise`），`V1.0` 默认为 `personal`
- API 契约显式定义并版本化（建议 `v1` 路径前缀）
- 请求链路输出结构化日志（JSON）
- 关键异常映射稳定错误码
- 每个 API 接口具备超时处理

## 6. 技术选型落位（V1.0）

- 前端：`Next.js` + `TypeScript` + `Tailwind CSS` + `shadcn/ui`
- 后端：`FastAPI` + `Pydantic v2` + `Uvicorn`
- 数据层：`PostgreSQL`（即使早期可简化，也需保证模型含 `tenant_id`）
- 缓存：`Redis`（V1.0 可先不启用业务依赖）
- 日志：结构化 JSON

## 7. 最小接口草案

## 7.1 `POST /api/v1/chat/completions`

- 请求体
  - `message: string`（必填）
  - `tenant_id: string`（必填，`V1.0` 可固定默认值）
  - `edition: "personal" | "enterprise"`（必填，`V1.0` 使用 `personal`）
- 成功响应
  - `answer: string`
  - `request_id: string`
  - `latency_ms: number`
- 失败响应
  - `error_code: string`
  - `error_message: string`
  - `request_id: string`

## 7.2 `GET /healthz`

- 响应：`200 OK` + 基础状态字段（如 `status: "ok"`）

## 8. 数据与模块草案

- 推荐最小表结构（示意）
  - `chat_requests`：`id`, `tenant_id`, `user_message`, `assistant_answer`, `created_at`
- 目录边界建议
  - `backend/app/modules/chat/*`
  - `backend/app/modules/memory/*`（空壳或占位）
  - `backend/app/modules/knowledge/*`（空壳或占位）
  - `backend/app/modules/tooling/*`（空壳或占位）

## 9. 验收标准（DoD + Roadmap）

- 用户可完成一次提问并收到回答
- 前后端可本地端到端运行
- 每次请求有结构化日志
- 常见失败场景返回明确错误
- 关键路径测试通过（至少覆盖成功、超时、参数非法）

## 10. 测试计划（V1.0）

- 后端单元测试
  - 请求参数校验
  - 错误码映射
  - 超时分支
- 后端集成测试
  - `POST /api/v1/chat/completions` 成功/失败路径
  - `GET /healthz`
- 前端基本联调验证
  - 提问、加载态、错误态、结果渲染

## 11. 回滚说明（V1.0）

- 回滚触发条件
  - 问答主链路不可用
  - 错误率持续超阈值
  - 响应延迟显著劣化
- 回滚策略
  - 接口级开关回退到稳定响应
  - 关闭新变更路径并保留日志采样
  - 保证 `/healthz` 与错误码行为稳定

## 12. 里程碑与交付物

- `M1` 设计冻结：本文件评审通过
- `M2` 骨架完成：前后端最小链路可跑通
- `M3` 验收通过：满足第 9 节标准并完成测试记录

## 13. 追踪来源

- `docs/foundation/PRD-v1.md`
- `docs/foundation/ROADMAP.md`
- `docs/foundation/ARCHITECTURE_GUARDRAILS.md`
- `docs/foundation/TECH_STACK.md`
- `docs/foundation/DEV_WORKFLOW.md`

## 14. UI 设计输入

- `ui/v1.0/homepage.png`
- `ui/v1.0/chat.png`
- UI 资产管理规则见 `docs/releases/v1.0/UI_ASSET_GUIDE_V1.0.md`

