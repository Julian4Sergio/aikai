# V1.1 执行计划

## 1. 版本策略

- 发布拆分：`V1.1.0`（体验底座）+ `V1.1.1`（会话增强）
- 主 KPI：体验提升（优先关注首 token 时间与流式交互顺滑度）
- 兼容原则：`V1.0` JSON 同步响应保持可用，不做破坏性变更

## 2. 范围定义

### 2.1 V1.1.0 In Scope

- `SSE` 流式输出能力
- 前端增量渲染与加载态优化
- 生成停止/取消全链路
- 流式相关观测指标（首包时间、取消率、流式失败率）

### 2.2 V1.1.1 In Scope

- 短窗口多轮上下文（`history` 注入，最近 N 轮）
- 会话连续性最小前端交互（续聊、刷新恢复）
- 流式 + 会话联调稳定性回归

### 2.3 Out of Scope

- 长期记忆机制
- RAG 与 MCP 工具调用
- 复杂租户管理与组织级权限能力

## 3. API 与契约策略

## 3.1 兼容路径

- 保留：`POST /api/v1/chat/completions`（`V1.0` 同步 JSON）
- 新增：`POST /api/v1/chat/stream`（`SSE`）
- 健康检查：`GET /healthz` 保持不变

## 3.2 流式接口最小约定（建议）

- 请求字段：`message`, `tenant_id`, `edition`, `history`（可选）
- 事件类型：`delta`, `done`, `error`
- 中止语义：客户端断开或取消后，服务端尽快停止上游生成并记录状态
- 错误约定：复用 `V1.0` 错误码语义，新增流式场景映射文档

## 4. 开发任务拆解

### 4.1 后端

- 增加 `SSE` endpoint 与事件封装
- 抽象统一生成管线（同步/流式共用核心逻辑）
- 增加取消信号处理与超时控制
- 增加 `history` 短窗口裁剪与注入逻辑
- 增加结构化日志字段（`is_stream`, `ttft_ms`, `cancelled`）

### 4.2 前端

- 新增流式消费与增量渲染
- 生成中取消按钮与状态切换
- 会话短窗口上下文组装（最近 N 轮）
- 会话连续性最小能力（刷新恢复当前会话）
- 失败回退到同步接口（可选开关）

### 4.3 测试

- 单元：事件编码、取消分支、history 裁剪
- 集成：流式成功/取消/异常、同步兼容路径
- E2E：首包可见、增量渲染、取消后 UI 恢复

## 5. 验收指标（建议阈值）

- `TTFT`（首 token 时间）较 `V1.0` 主观体验显著改善
- 流式成功率 >= 99%
- 取消请求可控结束率 >= 99%
- 同步兼容接口回归通过率 100%

## 6. 风险与对策

- 风险：流式与同步逻辑分叉导致维护成本上升
- 对策：生成核心逻辑单一实现，接口层只做协议适配

- 风险：前端取消与后端中止语义不一致
- 对策：统一取消状态机，并在日志中打点追踪

- 风险：history 注入导致 token 膨胀与时延波动
- 对策：固定短窗口 + 字符/Token 双阈值截断

## 7. 发布节奏（建议）

- `M1`：`V1.1.0` 开发完成（SSE + 取消 + 指标）
- `M2`：`V1.1.0` 回归与灰度
- `M3`：`V1.1.1` 开发完成（短窗口 + 会话连续性）
- `M4`：`V1.1.1` 回归并发布
